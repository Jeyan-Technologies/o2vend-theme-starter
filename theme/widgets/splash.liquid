{% liquid
  assign widget_settings = widget.settings
  assign widget_data = widget.data
  
  comment
    Static Widget: Content comes from widget_data.content (splash configuration)
    Settings come from widget_settings
  endcomment

  assign content_data = widget_data.content | default: widget.content
  if content_data.size > 0 and content_data.first.ImageUrl
    assign splash_config = content_data.first
  else
    assign splash_config = content_data
  endif

  assign image_url = splash_config.ImageUrl | default: splash_config.imageUrl | default: splash_config.Image | default: splash_config.image
  if image_url == 'null' or image_url == ''
    assign image_url = nil
  endif
  
  assign link_text = splash_config.LinkText | default: splash_config.linkText | default: splash_config.ButtonText | default: splash_config.buttonText
  if link_text == 'null' or link_text == ''
    assign link_text = nil
  endif
  
  assign target_url = splash_config.TargetUrl | default: splash_config.targetUrl | default: splash_config.Link | default: splash_config.link
  if target_url == 'null' or target_url == ''
    assign target_url = nil
  endif
  
  assign title = splash_config.Title | default: splash_config.title
  if title == 'null' or title == ''
    assign title = nil
  endif
  
  assign description = splash_config.Description | default: splash_config.description
  if description == 'null' or description == ''
    assign description = nil
  endif
  
  assign background_color = widget_settings.backgroundColor | default: splash_config.BackgroundColor | default: splash_config.backgroundColor
  if background_color == 'null' or background_color == '' or background_color == nil
    assign background_color = '#ffffff'
  endif
  
  assign text_color = widget_settings.textColor | default: splash_config.TextColor | default: splash_config.textColor
  if text_color == 'null' or text_color == '' or text_color == nil
    assign text_color = '#111111'
  endif
  
  assign delay_seconds = widget_settings.seconds | default: splash_config.Seconds | default: splash_config.seconds | default: splash_config.DelaySeconds | default: splash_config.delaySeconds
  if delay_seconds == 'null' or delay_seconds == '' or delay_seconds == nil
    assign delay_seconds = 1
  endif
  
  assign show_once = widget_settings.showOnce | default: splash_config.ShowOnce | default: splash_config.showOnce | default: true
  assign overlay_color = widget_settings.overlayColor | default: splash_config.OverlayColor | default: splash_config.overlayColor | default: 'rgba(0,0,0,0.6)'
  assign event_type = widget_settings.eventType | default: splash_config.EventType | default: splash_config.eventType | default: 'Onload'
%}

{% assign splash_id = widget.id | default: widget._id | default: 'splash-default' %}

<!-- DEBUG: Splash Widget Loaded - ID: {{ splash_id }}, Image: {{ image_url }}, Delay: {{ delay_seconds }} -->

<div class="widget-splash-overlay" data-splash-widget data-widget-id="{{ splash_id }}" data-delay="{{ delay_seconds }}" data-show-once="false" data-event-type="{{ event_type }}">
  <div class="widget-splash-modal" style="background-color: {{ background_color }};">
    <!-- Close Button -->
    <button type="button" class="splash-close" data-splash-close aria-label="Close">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    
    <div class="splash-content">
      {% if image_url %}
        <div class="splash-image">
          {% if target_url %}
            <a href="{{ target_url }}">
              <img src="{{ image_url }}" alt="{{ title | default: 'Special Offer' }}" width="800" height="450" loading="lazy">
            </a>
          {% else %}
            <img src="{{ image_url }}" alt="{{ title | default: 'Special Offer' }}" width="800" height="450" loading="lazy">
          {% endif %}
        </div>
      {% endif %}
      
      {% if title or description or link_text %}
        <div class="splash-body" style="color: {{ text_color }};">
          {% if title %}
            <h2 class="splash-title">{{ title }}</h2>
          {% endif %}
          
          {% if description %}
            <p class="splash-description">{{ description }}</p>
          {% endif %}
          
          {% if link_text and target_url %}
            <a href="{{ target_url }}" class="splash-cta">{{ link_text }}</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  /* Splash Overlay */
  .widget-splash-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: {{ overlay_color }};
    z-index: 99999;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .widget-splash-overlay.active {
    display: flex;
  }
  
  .widget-splash-overlay.visible {
    opacity: 1;
  }
  
  /* Modal */
  .widget-splash-modal {
    position: relative;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    border-radius: var(--border-radius-medium);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    transform: scale(0.9) translateY(20px);
    transition: transform 0.3s ease;
  }
  
  .widget-splash-overlay.visible .widget-splash-modal {
    transform: scale(1) translateY(0);
  }
  
  /* Close Button */
  .splash-close {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    border: none;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    z-index: 10;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .splash-close:hover {
    background: #fff;
    transform: scale(1.1);
  }
  
  /* Content */
  .splash-content {
    display: flex;
    flex-direction: column;
  }
  
  /* Image */
  .splash-image {
    width: 100%;
    overflow: hidden;
  }
  
  .splash-image img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }
  
  .splash-image a {
    display: block;
  }
  
  /* Body */
  .splash-body {
    padding: 24px;
    text-align: center;
  }
  
  .splash-title {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 12px 0;
    line-height: 1.3;
  }
  
  .splash-description {
    font-size: 15px;
    line-height: 1.6;
    margin: 0 0 20px 0;
    opacity: 0.85;
  }
  
  /* CTA Button */
  .splash-cta {
    display: inline-block;
    padding: 14px 32px;
    background: #111;
    color: #fff !important;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .splash-cta:hover {
    background: #333;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  /* Image Only Mode (no title/description) */
  .splash-body:empty {
    display: none;
  }
  
  .splash-image + .splash-body:not(:has(.splash-title)):not(:has(.splash-description)):not(:has(.splash-cta)) {
    display: none;
  }
  
  /* Mobile */
  @media (max-width: 576px) {
    .widget-splash-overlay {
      padding: 16px;
    }
    
    .widget-splash-modal {
      max-width: 100%;
      border-radius: 12px;
    }
    
    .splash-close {
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
    }
    
    .splash-close svg {
      width: 20px;
      height: 20px;
    }
    
    .splash-body {
      padding: 20px 16px;
    }
    
    .splash-title {
      font-size: 20px;
    }
    
    .splash-description {
      font-size: 14px;
    }
    
    .splash-cta {
      padding: 12px 24px;
      font-size: 13px;
      width: 100%;
      text-align: center;
    }
  }
</style>

<script>
(function() {
  console.log('[Splash] Script loaded for widget {{ splash_id }}');
  
  // Wait for DOM to be ready
  function initSplash() {
    console.log('[Splash] initSplash called');
    
    // Try multiple selectors
    let splashWidget = document.querySelector('[data-splash-widget][data-widget-id="{{ splash_id }}"]');
    if (!splashWidget) {
      splashWidget = document.querySelector('[data-splash-widget]');
    }
    if (!splashWidget) {
      splashWidget = document.querySelector('.widget-splash-overlay');
    }
    
    if (!splashWidget) {
      console.error('[Splash] Widget element NOT FOUND in DOM!');
      console.log('[Splash] Looking for: [data-splash-widget][data-widget-id="{{ splash_id }}"]');
      return;
    }
    
    console.log('[Splash] Widget element FOUND:', splashWidget);
    
    const delaySeconds = parseInt(splashWidget.dataset.delay) || 1;
    console.log('[Splash] Delay seconds:', delaySeconds);
    
    // Show splash after delay
    console.log('[Splash] Setting timeout for', delaySeconds, 'second(s)...');
    setTimeout(function() {
      console.log('[Splash] TIMEOUT FIRED - Showing popup NOW!');
      splashWidget.style.display = 'flex';
      splashWidget.classList.add('active');
      // Trigger animation after a frame
      setTimeout(function() {
        splashWidget.classList.add('visible');
        console.log('[Splash] Added visible class');
      }, 50);
    }, delaySeconds * 1000);
    
    // Close function
    function closeSplash() {
      console.log('[Splash] Closing popup');
      splashWidget.classList.remove('visible');
      setTimeout(function() {
        splashWidget.classList.remove('active');
        splashWidget.style.display = 'none';
      }, 300);
    }
    
    // Close button click
    const closeBtn = splashWidget.querySelector('[data-splash-close]');
    if (closeBtn) {
      closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeSplash();
      });
    }
    
    // Close on overlay click
    splashWidget.addEventListener('click', function(e) {
      if (e.target === splashWidget) {
        closeSplash();
      }
    });
    
    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && splashWidget.classList.contains('active')) {
        closeSplash();
      }
    });
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    console.log('[Splash] DOM still loading, waiting...');
    document.addEventListener('DOMContentLoaded', initSplash);
  } else {
    console.log('[Splash] DOM ready, initializing in 100ms...');
    setTimeout(initSplash, 100);
  }
})();
</script>
